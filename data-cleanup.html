<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS Data Cleanup Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #5a6fd8; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #b8daff; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; }
        .large-data { color: #dc3545; font-weight: bold; }
        .completed { color: #28a745; }
        .progress { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ LifeOS Data Cleanup Tool</h1>
        <p><strong>Purpose:</strong> Manage your massive dataset (5,265 todos!) and optimize storage</p>
        
        <div class="section">
            <h2>üìä Data Analysis</h2>
            <button onclick="analyzeData()">Analyze Current Data</button>
            <div id="analysisResults"></div>
        </div>

        <div class="section">
            <h2>üóëÔ∏è Data Cleanup Options</h2>
            <button onclick="removeCompleted()">Remove Completed Tasks</button>
            <button onclick="removeDuplicates()">Remove Duplicate Tasks</button>
            <button onclick="removeOldTasks()">Remove Tasks Older Than 1 Year</button>
            <button onclick="compactData()">Compact Data (Remove Empty Fields)</button>
            <div id="cleanupResults"></div>
        </div>

        <div class="section">
            <h2>üì¶ Export Cleaned Data</h2>
            <button onclick="exportCleanedData()">Export Optimized Dataset</button>
            <button onclick="exportRecentTasks()">Export Recent Tasks Only (Last 6 Months)</button>
            <div id="exportResults"></div>
        </div>

        <div class="section">
            <h2>‚ö†Ô∏è Emergency Options</h2>
            <button onclick="backupAllData()" class="warning">Backup All Data First</button>
            <button onclick="clearAllTodos()" class="danger">Clear All Todos (DANGEROUS)</button>
            <div id="emergencyResults"></div>
        </div>
    </div>

    <script>
        let currentTodos = [];
        
        function analyzeData() {
            try {
                const todos = localStorage.getItem('myEnhancedTodos');
                if (!todos) {
                    document.getElementById('analysisResults').innerHTML = 
                        '<div class="warning">No todo data found in localStorage</div>';
                    return;
                }

                currentTodos = JSON.parse(todos);
                
                // Analyze the data
                const completed = currentTodos.filter(t => t.completed).length;
                const inProgress = currentTodos.length - completed;
                const hasDescription = currentTodos.filter(t => t.description && t.description.length > 0).length;
                const hasDueDate = currentTodos.filter(t => t.dueDate).length;
                const isRecurring = currentTodos.filter(t => t.isRecurring).length;
                const isHabit = currentTodos.filter(t => t.isHabit).length;
                
                // Find duplicates
                const titles = currentTodos.map(t => t.title.toLowerCase());
                const duplicates = titles.filter((title, index) => titles.indexOf(title) !== index);
                const uniqueDuplicates = [...new Set(duplicates)];
                
                // Find old tasks
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                const oldTasks = currentTodos.filter(t => {
                    const created = new Date(t.createdDate || t.created || 0);
                    return created < oneYearAgo;
                }).length;

                // Calculate storage size
                const dataSize = new Blob([todos]).size;
                const sizeInMB = (dataSize / (1024 * 1024)).toFixed(2);

                document.getElementById('analysisResults').innerHTML = `
                    <div class="info">
                        <h3>üìà Dataset Analysis</h3>
                        <table>
                            <tr><th>Metric</th><th>Count</th><th>Notes</th></tr>
                            <tr><td>Total Tasks</td><td class="large-data">${currentTodos.length}</td><td>Very large dataset!</td></tr>
                            <tr><td>Completed Tasks</td><td class="completed">${completed}</td><td>${((completed/currentTodos.length)*100).toFixed(1)}%</td></tr>
                            <tr><td>In Progress</td><td class="progress">${inProgress}</td><td>${((inProgress/currentTodos.length)*100).toFixed(1)}%</td></tr>
                            <tr><td>With Descriptions</td><td>${hasDescription}</td><td>${((hasDescription/currentTodos.length)*100).toFixed(1)}%</td></tr>
                            <tr><td>With Due Dates</td><td>${hasDueDate}</td><td>${((hasDueDate/currentTodos.length)*100).toFixed(1)}%</td></tr>
                            <tr><td>Recurring Tasks</td><td>${isRecurring}</td><td>Automated tasks</td></tr>
                            <tr><td>Habit Tasks</td><td>${isHabit}</td><td>Daily habits</td></tr>
                            <tr><td>Duplicate Titles</td><td class="large-data">${uniqueDuplicates.length}</td><td>Potential cleanup target</td></tr>
                            <tr><td>Tasks Older Than 1 Year</td><td class="large-data">${oldTasks}</td><td>Archive candidates</td></tr>
                            <tr><td>Storage Size</td><td class="large-data">${sizeInMB} MB</td><td>May exceed browser limits</td></tr>
                        </table>
                        
                        ${sizeInMB > 5 ? '<div class="error"><strong>‚ö†Ô∏è Warning:</strong> Data size exceeds typical localStorage limits (5-10MB). Cleanup recommended.</div>' : ''}
                        ${completed > currentTodos.length * 0.7 ? '<div class="warning"><strong>üí° Suggestion:</strong> Consider archiving completed tasks to reduce size.</div>' : ''}
                        ${uniqueDuplicates.length > 50 ? '<div class="warning"><strong>üí° Suggestion:</strong> Many duplicate titles found. Consider deduplication.</div>' : ''}
                    </div>
                `;

            } catch (error) {
                document.getElementById('analysisResults').innerHTML = 
                    `<div class="error">Error analyzing data: ${error.message}</div>`;
            }
        }

        function removeCompleted() {
            try {
                if (currentTodos.length === 0) {
                    analyzeData(); // Load data first
                }
                
                const beforeCount = currentTodos.length;
                const completedTodos = currentTodos.filter(t => t.completed);
                currentTodos = currentTodos.filter(t => !t.completed);
                
                // Save the cleaned data
                localStorage.setItem('myEnhancedTodos', JSON.stringify(currentTodos));
                
                document.getElementById('cleanupResults').innerHTML = 
                    `<div class="success">‚úÖ Removed ${completedTodos.length} completed tasks. 
                    Dataset reduced from ${beforeCount} to ${currentTodos.length} tasks.</div>`;
                    
            } catch (error) {
                document.getElementById('cleanupResults').innerHTML = 
                    `<div class="error">Error removing completed tasks: ${error.message}</div>`;
            }
        }

        function removeDuplicates() {
            try {
                if (currentTodos.length === 0) {
                    analyzeData(); // Load data first
                }
                
                const beforeCount = currentTodos.length;
                const seen = new Set();
                const uniqueTodos = [];
                
                currentTodos.forEach(todo => {
                    const key = `${todo.title.toLowerCase()}_${todo.dueDate || ''}_${todo.completed}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueTodos.push(todo);
                    }
                });
                
                currentTodos = uniqueTodos;
                localStorage.setItem('myEnhancedTodos', JSON.stringify(currentTodos));
                
                document.getElementById('cleanupResults').innerHTML = 
                    `<div class="success">‚úÖ Removed ${beforeCount - currentTodos.length} duplicate tasks. 
                    Dataset reduced from ${beforeCount} to ${currentTodos.length} tasks.</div>`;
                    
            } catch (error) {
                document.getElementById('cleanupResults').innerHTML = 
                    `<div class="error">Error removing duplicates: ${error.message}</div>`;
            }
        }

        function removeOldTasks() {
            try {
                if (currentTodos.length === 0) {
                    analyzeData(); // Load data first
                }
                
                const beforeCount = currentTodos.length;
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                currentTodos = currentTodos.filter(todo => {
                    const created = new Date(todo.createdDate || todo.created || Date.now());
                    return created >= oneYearAgo;
                });
                
                localStorage.setItem('myEnhancedTodos', JSON.stringify(currentTodos));
                
                document.getElementById('cleanupResults').innerHTML = 
                    `<div class="success">‚úÖ Removed ${beforeCount - currentTodos.length} tasks older than 1 year. 
                    Dataset reduced from ${beforeCount} to ${currentTodos.length} tasks.</div>`;
                    
            } catch (error) {
                document.getElementById('cleanupResults').innerHTML = 
                    `<div class="error">Error removing old tasks: ${error.message}</div>`;
            }
        }

        function compactData() {
            try {
                if (currentTodos.length === 0) {
                    analyzeData(); // Load data first
                }
                
                const beforeSize = new Blob([JSON.stringify(currentTodos)]).size;
                
                // Remove empty fields and optimize data
                currentTodos = currentTodos.map(todo => {
                    const cleaned = { ...todo };
                    
                    // Remove empty or default values
                    if (!cleaned.description || cleaned.description.trim() === '') delete cleaned.description;
                    if (!cleaned.categories || cleaned.categories.length === 0) delete cleaned.categories;
                    if (!cleaned.dueDate) delete cleaned.dueDate;
                    if (cleaned.progress === 0) delete cleaned.progress;
                    if (cleaned.priority === 'medium') delete cleaned.priority; // default
                    if (!cleaned.isRecurring) delete cleaned.isRecurring;
                    if (!cleaned.isHabit) delete cleaned.isHabit;
                    
                    return cleaned;
                });
                
                const afterSize = new Blob([JSON.stringify(currentTodos)]).size;
                const savedMB = ((beforeSize - afterSize) / (1024 * 1024)).toFixed(2);
                
                localStorage.setItem('myEnhancedTodos', JSON.stringify(currentTodos));
                
                document.getElementById('cleanupResults').innerHTML = 
                    `<div class="success">‚úÖ Data compacted. Saved ${savedMB} MB of storage space.</div>`;
                    
            } catch (error) {
                document.getElementById('cleanupResults').innerHTML = 
                    `<div class="error">Error compacting data: ${error.message}</div>`;
            }
        }

        function exportRecentTasks() {
            try {
                if (currentTodos.length === 0) {
                    analyzeData(); // Load data first
                }
                
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                
                const recentTodos = currentTodos.filter(todo => {
                    const created = new Date(todo.createdDate || todo.created || Date.now());
                    return created >= sixMonthsAgo;
                });
                
                const exportData = {
                    protocol: window.location.protocol,
                    exportDate: new Date().toISOString(),
                    note: "Recent tasks only (last 6 months)",
                    originalCount: currentTodos.length,
                    exportedCount: recentTodos.length,
                    data: {
                        todos: recentTodos
                    }
                };
                
                const exportString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([exportString], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lifeos-recent-todos-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                document.getElementById('exportResults').innerHTML = 
                    `<div class="success">‚úÖ Exported ${recentTodos.length} recent tasks out of ${currentTodos.length} total.</div>`;
                    
            } catch (error) {
                document.getElementById('exportResults').innerHTML = 
                    `<div class="error">Error exporting recent tasks: ${error.message}</div>`;
            }
        }

        function exportCleanedData() {
            try {
                if (currentTodos.length === 0) {
                    analyzeData(); // Load data first
                }
                
                const exportData = {
                    protocol: window.location.protocol,
                    exportDate: new Date().toISOString(),
                    note: "Cleaned and optimized dataset",
                    data: {
                        todos: currentTodos
                    }
                };
                
                const exportString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([exportString], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lifeos-cleaned-todos-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                document.getElementById('exportResults').innerHTML = 
                    `<div class="success">‚úÖ Exported cleaned dataset with ${currentTodos.length} tasks.</div>`;
                    
            } catch (error) {
                document.getElementById('exportResults').innerHTML = 
                    `<div class="error">Error exporting cleaned data: ${error.message}</div>`;
            }
        }

        function backupAllData() {
            try {
                const allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    allData[key] = localStorage.getItem(key);
                }
                
                const exportString = JSON.stringify(allData, null, 2);
                const blob = new Blob([exportString], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lifeos-full-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                document.getElementById('emergencyResults').innerHTML = 
                    `<div class="success">‚úÖ Full backup created with ${localStorage.length} localStorage items.</div>`;
                    
            } catch (error) {
                document.getElementById('emergencyResults').innerHTML = 
                    `<div class="error">Error creating backup: ${error.message}</div>`;
            }
        }

        function clearAllTodos() {
            if (confirm('‚ö†Ô∏è This will permanently delete ALL your todos! Are you absolutely sure?')) {
                if (confirm('üö® FINAL WARNING: This cannot be undone! Continue?')) {
                    localStorage.removeItem('myEnhancedTodos');
                    currentTodos = [];
                    document.getElementById('emergencyResults').innerHTML = 
                        `<div class="error">üóëÔ∏è All todos have been deleted.</div>`;
                }
            }
        }

        // Auto-analyze on load
        window.addEventListener('load', analyzeData);
    </script>
</body>
</html>